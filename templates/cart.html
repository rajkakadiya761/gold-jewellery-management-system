<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arihant Jewellers</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.9.1/font/bootstrap-icons.min.css"
        rel="stylesheet">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/ari.png') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>




    <style>
        .modal {
            z-index: 1055 !important;
        }

        .modal-backdrop {
            z-index: 1050 !important;
        }

        .modal-dialog {
            margin-top: 80px;
            /* Adjust this based on navbar height */
        }

        body {
            background-color: black;
            color: white;
            margin-bottom: 1px;
        }

        .card {
            background-color: rgb(33, 37, 41);
            border-radius: 10px;
            color: white;
        }

        .sticky-checkout {
            position: sticky;
            bottom: 0;
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            color: black;
            text-align: center;
        }

        .dropdown-item:hover {
            background-color: rgb(78, 65, 48);
        }

        .container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #cart-items {
            flex-grow: 1;
        }

        .quantity {
            margin: 0 10px;
        }

        .modal-body {

            text-align: left;
        }

        .modal-content {
            background-color: rgb(33, 37, 41);

            /* Greyish black modal background */
            color: white;
            /* White text for readability */
        }

        .modal-header {
            border-bottom: 1px solid #444;
            /* Darker border for header */
        }

        .modal-footer {
            border-top: 1px solid #444;
            /* Darker border for footer */
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1050;
        }

        .notification.warning {
            background-color: #ffc107;
            /* Bootstrap warning color */
            color: black;
        }

        .notification.error {
            background-color: #64675d6f;
            color: white;
        }

        /* .notification {
            position: fixed;
            background-color: #333;
            color: white;
            border-radius: 5px;

        }

        .notification.warning {
            background-color: #f6d163;
            color: black;
        }

        .notification.error {
            background-color: #ffc107;
            color: white;
        } */
    </style>
</head>

<body>

    <nav class="navbar navbar-expand-lg text-light bg-black p-3 sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fs-5 text-uppercase fw-bold text-warning">Arihant Jewelers</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-l abel="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-between" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active text-light fw-bold px-3" aria-current="page" href="/#start">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-light fw-bold px-3" href="{{ url_for('page1') }}#About">About us</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-light fw-bold px-3" href="#" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false"
                            style="border-radius: 8px; transition: background 0.3s;">
                            Shop by Category
                        </a>
                        <ul class="dropdown-menu bg-dark p-3" style="min-width: 500px;">
                            <div class="row">

                                <!-- Column 1: Products & Material -->
                                <div class="col-md-6">
                                    <h6 class="dropdown-header text-warning">Products</h6>
                                    <a class="dropdown-item text-light"
                                        href="{{ url_for('product.show_earrings') }}">Earrings</a>
                                    <a class="dropdown-item text-light"
                                        href="{{ url_for('productFinger.show_rings') }}">Rings</a>
                                    <a class="dropdown-item text-light"
                                        href="{{ url_for('productHand.show_braceletes') }}">Bracelets</a>
                                    <a class="dropdown-item text-light"
                                        href="{{ url_for('productNeck.show_necklaces') }}">Necklaces</a>

                                    <hr class="dropdown-divider">

                                    <h6 class="dropdown-header text-warning">Material</h6>
                                    <a class="dropdown-item text-light"
                                        href="{{ url_for('productGold.show_gold_products') }}">Gold Jewellery</a>
                                    <a class="dropdown-item text-light"
                                        href="{{ url_for('productSilver.show_silver_products') }}">Silver Jewellery</a>
                                    <a class="dropdown-item text-light"
                                        href="{{ url_for('productPlatinum.show_platinum_products') }}">Platinum
                                        Jewellery</a>
                                </div>

                                <!-- Column 2: For You & Occasion -->
                                <div class="col-md-6">
                                    <h6 class="dropdown-header text-warning">For You</h6>
                                    <a class="dropdown-item text-light"
                                        href="{{ url_for('productMale.show_male_products') }}">Men's Collection</a>
                                    <a class="dropdown-item text-light"
                                        href="{{ url_for('productFemale.show_female_products') }}">Women's
                                        Collection</a>
                                    <a class="dropdown-item text-light"
                                        href="{{ url_for('productUni.show_uni_products') }}">Unisex Collection</a>

                                    <hr class="dropdown-divider">

                                    <h6 class="dropdown-header text-warning">Occasion</h6>
                                    <a class="dropdown-item text-light"
                                        href="{{ url_for('productWedding.show_wedding_products') }}">Wedding
                                        Collection</a>
                                    <a class="dropdown-item text-light"
                                        href="{{ url_for('productMinimal.show_minimal_products') }}">Minimal
                                        Collection</a>
                                </div>
                            </div>

                            <!-- Full-Width Latest Collection at Bottom -->
                            <hr class="dropdown-divider">
                            <a class="dropdown-item text-light fw-bold text-center"
                                href="{{ url_for('page1') }}#latest">âœ¨ Our Latest Collection</a>
                        </ul>

                    </li>
                </ul>

                <!-- Centered Search Bar -->
                <form class="d-flex mx-auto" role="search" style="flex: 1; justify-content: center;"
                    action="{{ url_for('search') }}" method="GET">
                    <input class="form-control me-2 p-2" type="search" name="query" placeholder="Search"
                        aria-label="Search" style="width: 60%;">
                    <button type="submit" class="btn btn-outline-warning">Search</button>
                </form>

                <div class="d-flex">
                    {% if session['user_id'] %}
                    <!-- Logout Button -->
                    <form action="{{ url_for('logout') }}" method="POST">
                        <button class="btn btn-outline-warning me-2" type="submit">
                            Logout
                        </button>
                    </form>
                    {% else %}
                    <!-- Login Button -->
                    <button class="btn btn-outline-warning me-2" type="button" data-bs-toggle="modal"
                        data-bs-target="#loginModal">
                        <i class="bi bi-person"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>
    {% include 'LoginSignUp_Modal.html' %}

    {% if show_modal %}
    <!-- Modal for Password Reset -->
    <div class="modal fade" id="passwordResetModal" tabindex="-1" aria-labelledby="passwordResetModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="passwordResetModalLabel">Reset Your Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="resetPasswordForm" action="/reset-password" method="POST">
                        <div class="mb-3">
                            <label for="resetEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="resetEmail" value="{{ email }}" name="email"
                                readonly>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" name="newPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Change Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const modal = new bootstrap.Modal(document.getElementById('passwordResetModal'));
            modal.show();
        });

    </script>
    {% endif %}

    <div class="container-fluid mt-4">
        <h2 class="text-center mb-4">ðŸ›’ Shopping Cart</h2>
        <div id="cart-items">
            <div id="notificationMessage" class="notification error p-3 text-center"
                style="display: none; position: fixed; top: 20px; right: 20px; z-index: 1000; min-width: 250px; max-width: 300px;">
            </div>
            {% for item in cart_items %}
            <a href="{{ url_for('product.earring_details', product_id=item.product_id) }}"
                class="text-decoration-none text-white">
                <div class="card p-3 mt-3" data-product-id="{{ item.product_id }}">
                    <div class="row align-items-center">
                        <div class="col-md-2 text-center">
                            <img src="{{ item.photo1 }}" class="img-fluid" alt="{{ item.name }}">
                        </div>
                        <div class="col-md-6 text-center text-md-start">
                            <h5>{{ item.name }}</h5>
                            <span class="fw-bold">â‚¹{{ item.price }}</span>
                        </div>
                        <div class="col-md-2 d-flex align-items-center justify-content-center gap-2">
                            <button class="btn btn-outline-secondary px-2 py-1" onclick="updateQuantity(this, -1, event)">âˆ’</button>
                            <span class="quantity px-3">1</span>
                            <button class="btn btn-outline-secondary px-2 py-1" onclick="updateQuantity(this, 1, event)">+</button>
                        </div>                                               
                        <div class="col-md-2 text-center">
                            <button class="btn btn-outline-warning" onclick="removeItem(this, event)">Remove</button>
                        </div>


                    </div>
                </div>

                {% else %}
                <div class="alert alert-warning text-center" role="alert">
                    Your cart is empty.
                </div>
                {% endfor %}
            </a>
        </div>

        <div class="sticky-checkout ">
            <h4>Total: â‚¹<span id="total-amount">0</span></h4>
            <button type="button" class="btn btn-warning" id="checkoutButton" data-bs-toggle="modal"
                data-bs-target="#addressModal">
                Checkout
            </button>

            <!-- Modal -->
            <div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel"
                aria-hidden="true" data-bs-backdrop="false">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="addressModalLabel">Enter Your Address</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="checkout-form">
                                <input type="hidden" id="product_ids" name="product_ids" value="">

                                <div class="mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <input type="text" class="form-control" id="address" name="address"
                                        placeholder="Enter your full address" required>
                                </div>
                                <div class="mb-3">
                                    <label for="state" class="form-label">State</label>
                                    <select class="form-control" id="state" name="state" required>
                                        <option value="">Select State</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="city" class="form-label">City</label>
                                    <input type="text" class="form-control" id="city" name="city"
                                        placeholder="Enter your city" required>
                                </div>
                                <div class="mb-3">
                                    <label for="postal_code" class="form-label">Postal Code</label>
                                    <input type="text" class="form-control" id="postal_code" name="postal_code"
                                        placeholder="6-digit Postal Code" required pattern="\d{6}"
                                        title="Please enter a valid postal code (6 digits)">
                                </div>
                                <div class="mb-3">
                                    <label for="phone_number" class="form-label">Phone Number</label>
                                    <input type="text" class="form-control" id="phone_number" name="phone_number"
                                        placeholder="10-digit Phone Number" required pattern="^\d{10}$"
                                        title="Please enter a valid phone number (10 digits)">
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Save Address</button>
                            </form>
                            <div id="order-message" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
            <script>
                const stateSelect = document.getElementById('state');
                const states = ["Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal", "Andaman and Nicobar Islands", "Chandigarh", "Dadra and Nagar Haveli and Daman and Diu", "Lakshadweep", "Delhi", "Puducherry"];
                states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    stateSelect.appendChild(option);
                });

                const checkoutButton = document.getElementById('checkoutButton');
                checkoutButton.addEventListener('click', async () => {
                    try {
                        // âœ… Pehle address fetch karo
                        const response = await fetch('/get_address');
                        const data = await response.json();

                        if (data.exists) {
                            document.getElementById('address').value = data.address;
                            document.getElementById('state').value = data.state;
                            document.getElementById('city').value = data.city;
                            document.getElementById('postal_code').value = data.postal_code;
                            document.getElementById('phone_number').value = data.phone_number;
                        }

                        // âœ… Phir product IDs aur quantities store karo
                        // âœ… Product IDs aur quantities store karo (Bina hidden input ke)
                        window.selectedProducts = [...document.querySelectorAll('.card[data-product-id]')].map(card => ({
                            id: card.getAttribute('data-product-id'),
                            quantity: parseInt(card.querySelector(".quantity").innerText) || 1
                        }));

                        console.log("Selected Products:", window.selectedProducts); // âœ… Debugging ke liye

                    } catch (error) {
                        console.error("Error fetching address:", error);
                    }
                });


                document.getElementById('checkout-form').addEventListener('submit', async function (event) {
                    event.preventDefault();

                    const address = document.getElementById('address').value;
                    const state = document.getElementById('state').value;
                    const city = document.getElementById('city').value;
                    const postalCode = document.getElementById('postal_code').value;
                    const phoneNumber = document.getElementById('phone_number').value;

                    try {
                        const response = await fetch('/save_address', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                product_ids: window.selectedProducts.map(p => p.id),
                                address, state, city,
                                postal_code: postalCode,
                                phone_number: phoneNumber
                            })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            document.getElementById('order-message').innerHTML = `<div class="alert alert-success">${result.message}</div>`;
                            setTimeout(() => bootstrap.Modal.getInstance(document.getElementById('addressModal')).hide(), 2000);

                            // âœ… Correctly call triggerPayment with an array
                            triggerPayment(window.selectedProducts);
                        } else {
                            document.getElementById('order-message').innerHTML = `<div class="alert alert-danger">${result.error}</div>`;
                        }

                    } catch (error) {
                        console.error("Error submitting address:", error);
                    }
                });

                async function triggerPayment(selectedProducts) {
                    try {
                        console.log("Initiating payment with Products:", selectedProducts); // âœ… Debugging ke liye

                        const response = await fetch('/initiate_payment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                product_ids: selectedProducts.map(p => p.id),
                                quantities: selectedProducts.map(p => p.quantity)
                            })
                        });

                        const data = await response.json();
                        console.log("Payment Response:", data); // âœ… Debugging ke liye

                        if (response.ok && data.order_id) {
                            console.log("Opening Razorpay..."); // âœ… Debugging ke liye
                            const options = {
                                "key": "rzp_test_rrFzDrB1DENkoe",
                                "amount": data.amount,
                                "currency": data.currency,
                                "order_id": data.order_id,
                                "handler": async function (response) {
                                    try {
                                        const saveResponse = await fetch('/payment_success', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({
                                                product_ids: selectedProducts.map(p => p.id),
                                                quantities: selectedProducts.map(p => p.quantity),
                                                price: (data.amount / 100).toFixed(2),
                                                transaction_id: response.razorpay_payment_id
                                            })
                                        });

                                        const result = await saveResponse.json();
                                        if (saveResponse.ok) {
                                            alert('âœ… Payment successful and saved!');
                                        } else {
                                            alert('âš  Payment done but saving failed: ' + result.error);
                                        }
                                    } catch (error) {
                                        console.error("Saving error:", error);
                                        alert('âš  Payment successful but failed to save in DB.');
                                    }
                                },
                                "theme": { "color":"#F37254"}
                            };

                            var rzp = new Razorpay(options);
                            rzp.open();
                        } else {
                            alert('Error initiating payment: ' + (data.error || 'Unknown error'));
                        }

                    } catch (error) {
                        console.error("Error initiating payment:", error);
                        alert('Failed to initiate payment');
                    }
                }

            </script>

        </div>
    </div>


    <script>
        function showNotification(message, type) {
            $('#notificationMessage').removeClass('success error info').addClass(type);
            $('#notificationMessage').text(message).fadeIn();
            setTimeout(function () {
                $('#notificationMessage').fadeOut();
            }, 3000);
        }

        function updateTotal() {
            let total = 0;
            document.querySelectorAll(".card").forEach(card => {
                let price = parseFloat(card.querySelector(".fw-bold").innerText.replace('â‚¹', ''));
                let quantity = parseInt(card.querySelector(".quantity").innerText);
                total += price * quantity;
            });
            document.getElementById("total-amount").innerText = total.toFixed(2);
        }

        function updateQuantity(button, change) {
            let quantityElement = button.parentElement.querySelector(".quantity");
            let quantity = parseInt(quantityElement.innerText);
            quantity = Math.max(1, quantity + change);
            quantityElement.innerText = quantity;
            updateTotal();
        }


        function removeItem(button, event) {
            event.stopPropagation(); // Prevent the click from propagating to the parent <a> tag
            event.preventDefault();

            let card = button.closest(".card");
            let productId = card.getAttribute("data-product-id");

            fetch(`/remove-from-cart/${productId}`, {
                method: 'POST',
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message === "Item removed from cart") {
                        card.remove();
                        updateTotal();
                        showNotification('Item removed from cart', 'error');
                    } else {
                        showNotification('Failed to remove item from cart', 'error');
                    }
                })
                .catch(error => console.error("Error:", error));
        }

        // Initial total calculation
        updateTotal();
    </script>
    <script>
        function showNotification(message, type) {
            $('#notificationMessage').removeClass('success error info').addClass(type);
            $('#notificationMessage').text(message).fadeIn();
            setTimeout(function () {
                $('#notificationMessage').fadeOut();
            }, 3000);
        }

        function updateTotal() {
            let total = 0;
            document.querySelectorAll(".card").forEach(card => {
                let price = parseFloat(card.querySelector(".fw-bold").innerText.replace('â‚¹', ''));
                let quantity = parseInt(card.querySelector(".quantity").innerText);
                total += price * quantity;
            });
            document.getElementById("total-amount").innerText = total.toFixed(2);
        }


        function updateQuantity(button, change, event) {
            event.stopPropagation();
            event.preventDefault();

            let quantityElement = button.parentElement.querySelector(".quantity");
            let quantity = parseInt(quantityElement.innerText);
            quantity = Math.max(1, quantity + change);
            quantityElement.innerText = quantity;
            updateTotal();
        }


        function removeItem(button, event) {
            event.stopPropagation(); // Prevent the click from propagating to the parent <a> tag
            event.preventDefault();

            let card = button.closest(".card");
            let productId = card.getAttribute("data-product-id");

            fetch(`/remove-from-cart/${productId}`, {
                method: 'POST',
            })
                .then(response => response.json())
                .then(data => {
                    if (data.message === "Item removed from cart") {
                        card.remove();
                        updateTotal();
                        showNotification('Item removed from cart', 'error');
                    } else {
                        showNotification('Failed to remove item from cart', 'error');
                    }
                })
                .catch(error => console.error("Error:", error));
        }



        // Initial total calculation
        updateTotal();
    </script>



    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>

</html>